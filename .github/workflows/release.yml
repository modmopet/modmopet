name: Release
on:
  push:
    branches:
    - main
    - rc
    - beta
    - nightly
    - hotfix
    - "*.x"

env:
  FLUTTER_VERSION: '3.10.x'

permissions:
  contents: write

jobs:
  get-version:
    uses: shiipou/github-actions/.github/workflows/get-version.yml@1-fix-flutter-release-didnt-work
    with:
      prerelease-branches: rc,beta,nightly,hotfix
  get-build:
    uses: shiipou/github-actions/.github/workflows/increment-variable.yml@1-fix-flutter-release-didnt-work
    with:
      variable-name: build_number
    secrets: 
      token: ${{ secrets.GH_TOKEN_WRITE_VARIABLES }}
  build:
    needs: [get-version, get-build]
    uses: shiipou/github-actions/.github/workflows/build-flutter.yml@1-fix-flutter-release-didnt-work
    strategy:
      matrix:
        platform: [ windows, linux, macos ]
        include:
          - platform: linux
            targets: zip,deb,rpm,appimage
            runner: ubuntu-latest
            artifacts: dist/linux/*.{zip,deb,rpm,AppImage}
          - platform: windows
            targets: zip,exe,msix
            runner: windows-latest
            artifacts: dist/windows/*.{zip,exe,msix}
          - platform: macos
            targets: zip,dmg
            runner: macos-latest
            artifacts: dist/macos/*.{zip,dmg}
    with:
      package-name: ModMopet
      version: ${{ needs.get-version.outputs.version }}
      build: ${{ needs.get-build.outputs.value }}

  release:
    needs: build
    uses: shiipou/github-actions/.github/workflows/release.yml@1-fix-flutter-release-didnt-work
    with:
      version:  ${{ needs.get-version.outputs.version }}
      changelogs: ${{ needs.get-version.outputs.changelogs }}
      is-prerelease: ${{ needs.get-version.outputs.is-prerelease }}
      download-artifacts: true
      assets: artifacts/*/*
